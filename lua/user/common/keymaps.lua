--[[
=====================================================================
                    ОБЩИЕ СОЧЕТАНИЯ КЛАВИШ
=====================================================================
Клавиатурные сокращения, работающие в обоих режимах:
- VSCode/Windsurf (через расширение vscode-neovim)
- Standalone Neovim

Лидер-клавиша: <Space>
=====================================================================
--]]

local keymap = vim.keymap.set
local opts = { noremap = true, silent = true }

-- =====================================================================
-- БАЗОВАЯ НАВИГАЦИЯ
-- =====================================================================

-- Перемещение по строкам с учетом переноса
keymap("n", "j", "v:count == 0 ? 'gj' : 'j'", { expr = true, silent = true, desc = "Вниз (с учетом переноса)" })
keymap("n", "k", "v:count == 0 ? 'gk' : 'k'", { expr = true, silent = true, desc = "Вверх (с учетом переноса)" })

-- Быстрое перемещение по полэкрана с центрированием
keymap("n", "<C-d>", "<C-d>zz", { desc = "Полэкрана вниз + центрирование" })
keymap("n", "<C-u>", "<C-u>zz", { desc = "Полэкрана вверх + центрирование" })

-- Центрирование при поиске
keymap("n", "n", "nzzzv", { desc = "Следующее совпадение + центрирование" })
keymap("n", "N", "Nzzzv", { desc = "Предыдущее совпадение + центрирование" })

-- =====================================================================
-- РЕДАКТИРОВАНИЕ
-- =====================================================================

-- Отмена подсветки поиска
keymap("n", "<Esc>", "<cmd>nohlsearch<CR>", { desc = "Убрать подсветку поиска" })

-- Перемещение строк в визуальном режиме
keymap("v", "J", ":m '>+1<CR>gv=gv", { desc = "Переместить строку вниз" })
keymap("v", "K", ":m '<-2<CR>gv=gv", { desc = "Переместить строку вверх" })

-- Сохранение позиции курсора при J (объединение строк)
keymap("n", "J", "mzJ`z", { desc = "Объединить строки (сохранить позицию)" })

-- Вставка без потери буфера
keymap("x", "<leader>p", [["_dP]], { desc = "Вставить без замены буфера" })

-- Удаление в черную дыру (не в буфер)
keymap({ "n", "v" }, "<leader>d", [["_d]], { desc = "Удалить (не в буфер)" })

-- Копирование в системный буфер
keymap({ "n", "v" }, "<leader>y", [["+y]], { desc = "Копировать в системный буфер" })
keymap("n", "<leader>Y", [["+Y]], { desc = "Копировать строку в системный буфер" })

-- =====================================================================
-- ОТСТУПЫ В ВИЗУАЛЬНОМ РЕЖИМЕ
-- =====================================================================

-- Сохранение выделения при изменении отступа
keymap("v", "<", "<gv", { desc = "Уменьшить отступ (сохранить выделение)" })
keymap("v", ">", ">gv", { desc = "Увеличить отступ (сохранить выделение)" })

-- =====================================================================
-- РАБОТА С ОКНАМИ
-- =====================================================================

-- Навигация между окнами (работает и в VSCode)
keymap("n", "<C-h>", "<C-w>h", { desc = "Окно слева" })
keymap("n", "<C-j>", "<C-w>j", { desc = "Окно снизу" })
keymap("n", "<C-k>", "<C-w>k", { desc = "Окно сверху" })
keymap("n", "<C-l>", "<C-w>l", { desc = "Окно справа" })

-- Изменение размера окон
keymap("n", "<C-Up>", "<cmd>resize +2<CR>", { desc = "Увеличить высоту окна" })
keymap("n", "<C-Down>", "<cmd>resize -2<CR>", { desc = "Уменьшить высоту окна" })
keymap("n", "<C-Left>", "<cmd>vertical resize -2<CR>", { desc = "Уменьшить ширину окна" })
keymap("n", "<C-Right>", "<cmd>vertical resize +2<CR>", { desc = "Увеличить ширину окна" })

-- =====================================================================
-- БУФЕРЫ
-- =====================================================================

keymap("n", "<S-h>", "<cmd>bprevious<CR>", { desc = "Предыдущий буфер" })
keymap("n", "<S-l>", "<cmd>bnext<CR>", { desc = "Следующий буфер" })
keymap("n", "[b", "<cmd>bprevious<CR>", { desc = "Предыдущий буфер" })
keymap("n", "]b", "<cmd>bnext<CR>", { desc = "Следующий буфер" })

-- =====================================================================
-- БЫСТРЫЕ ДЕЙСТВИЯ
-- =====================================================================

-- Сохранение файла
keymap("n", "<leader>w", "<cmd>w<CR>", { desc = "Сохранить файл" })
keymap("n", "<leader>W", "<cmd>wa<CR>", { desc = "Сохранить все файлы" })

-- Выход
keymap("n", "<leader>q", "<cmd>q<CR>", { desc = "Закрыть окно" })
keymap("n", "<leader>Q", "<cmd>qa<CR>", { desc = "Закрыть все" })

-- Сортировка выделенного текста
keymap("v", "gs", ":sort<CR>", { desc = "Сортировать выделенное" })

-- =====================================================================
-- ПОДСВЕТКА ПРИ КОПИРОВАНИИ (YANK)
-- =====================================================================

vim.api.nvim_create_autocmd("TextYankPost", {
  group = vim.api.nvim_create_augroup("highlight_yank", { clear = true }),
  pattern = "*",
  callback = function()
    vim.highlight.on_yank({
      higroup = "IncSearch",
      timeout = 200,
    })
  end,
  desc = "Подсветка при копировании текста",
})

print("✓ Общие сочетания клавиш загружены")
